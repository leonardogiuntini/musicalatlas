name: Build indexes and deploy to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate content-index.json and search-index.json from /menu
        run: |
          node - <<'NODE'
          const fs = require("fs");
          const path = require("path");

          const ROOT = "menu";
          const exts = new Set([".rtf"]);

          function titleize(name) {
            const base = name.replace(/\.rtf$/i, "").replace(/[_\-]+/g, " ").trim();
            return base.replace(/\b\w/g, c => c.toUpperCase());
          }

          // Simple RTF -> text extraction (for search)
          function rtfToPlainText(rtf) {
            let s = String(rtf || "");
            s = s.replace(/\{\\\*[^{}]*\}/g, " ");
            s = s.replace(/\\'[0-9a-fA-F]{2}/g, " ");
            s = s.replace(/\\[a-zA-Z]+\d* ?/g, " ");
            s = s.replace(/[{}]/g, " ");
            s = s.replace(/\s+/g, " ").trim();
            return s;
          }

          function scanDir(absDir, relParts, searchItems) {
            const node = {
              type: "folder",
              name: relParts[relParts.length - 1],
              title: titleize(relParts[relParts.length - 1]),
              path: [ROOT, ...relParts].join("/"),
              children: []
            };

            const entries = fs.readdirSync(absDir, { withFileTypes: true });
            for (const ent of entries) {
              const abs = path.join(absDir, ent.name);

              if (ent.isDirectory()) {
                node.children.push(scanDir(abs, [...relParts, ent.name], searchItems));
              } else if (ent.isFile()) {
                const ext = path.extname(ent.name).toLowerCase();
                if (!exts.has(ext)) continue;

                const pagePath = [ROOT, ...relParts, ent.name].join("/");
                const title = titleize(ent.name);

                node.children.push({
                  type: "page",
                  name: ent.name,
                  title,
                  path: pagePath
                });

                try {
                  const raw = fs.readFileSync(abs, "utf8");
                  const text = rtfToPlainText(raw);
                  searchItems.push({ path: pagePath, title, text });
                } catch {}
              }
            }

            node.children.sort((a,b) => (
              a.type === b.type ? a.title.localeCompare(b.title) : (a.type === "folder" ? -1 : 1)
            ));
            return node;
          }

          const items = [];
          const searchItems = [];

          if (fs.existsSync(ROOT) && fs.statSync(ROOT).isDirectory()) {
            const top = fs.readdirSync(ROOT, { withFileTypes: true });
            for (const ent of top) {
              if (!ent.isDirectory()) continue;
              items.push(scanDir(path.join(ROOT, ent.name), [ent.name], searchItems));
            }
          }
          items.sort((a,b) => a.title.localeCompare(b.title));

          // flat map kept for compatibility (not required by current UI)
          const flatPagesByKey = {};
          function normalizeName(s) {
            return String(s||"").trim().replace(/\.rtf$/i,"").toLowerCase();
          }
          function flatten(node) {
            for (const ch of (node.children || [])) {
              if (ch.type === "page") {
                const key = normalizeName(ch.title);
                if (!flatPagesByKey[key]) flatPagesByKey[key] = { title: ch.title, path: ch.path };
              } else if (ch.type === "folder") {
                flatten(ch);
              }
            }
          }
          for (const it of items) flatten(it);

          const generatedAt = new Date().toISOString();

          const index = {
            generatedAt,
            root: ROOT,
            items,
            flatPagesByKey
          };

          const searchIndex = {
            generatedAt,
            root: ROOT,
            items: searchItems
          };

          fs.writeFileSync("content-index.json", JSON.stringify(index, null, 2), "utf8");
          fs.writeFileSync("search-index.json", JSON.stringify(searchIndex, null, 2), "utf8");

          console.log("Wrote content-index.json and search-index.json");
          NODE

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
